# nginx-upstream-configure

このプログラムは、指定されたFQDNのIPアドレスをDNSで定期的に問い合わせ、nginxのupstream設定を動的に更新します。

## 動作の流れ

1. /etc/nginx/upstreams.d の下の設定ファイル（形式はYAMLで拡張子は .yml） を全て読み込み設定ファイルごとに以下の2.以降をの初期化処理を実行する。ただし、設定ファイルの name 要素が複数のファイルの間で重複している場合はエラーとする。以降、設定ファイルの name 要素の値を upstream 名とする。
2. upstream ごとの IP アドレステーブルを空で初期化する。
3. "upstream upstream名 {server 127.0.0.1:10080}" という内容で /etc/nginx/conf.d/upstream名.conf という名前で upstream コンフィグファイルを生成する。
4. すべての upstream の初期化処理が終わったら nginx を起動し、そのプロセスIDを記憶する。起動したプロセスを監視し、プロセスが異常終了した場合は、再起動する。異常終了を5回異常繰り返した場合は、このプログラム自身もエラーで終了する。
5. 設定ファイルごとに以下の6以降の処理を並列に実行する。
6. 設定ファイルの fqdn 要素に指定されている FQDN をDNSで問い合わせてそのIPアドレスが IP アドレステーブルに登録されていない場合は、登録し現在時刻を登録時刻として設定する.また、IPアドレステーブルに余分なものがあれば削除する。DNS 問い合わせに失敗した場合はIPアドレステーブルを空にする。
7. 前項 6. の処理でIPアドレステーブルに変化がなかった場合は、10 までスキップし、変化があった場合は以下の 8. 9. を実行する。このとき、他の設定ファイルと処理が競合しないようにロックを取得する。
8. /etc/nginx/conf.d/upstream名.conf という名前で upstream コンフィグファイルを出力する。このコンフィグファイルには upstream 名の upstream ディレクティブが1個を出力する。upstream の中に設定ファイルの maxips 要素に指定された個数（デフォルトは1）の server ディレクティブを出力する。このとき、IP アドレステーブルから登録日時が新しいものから順に出力し、余ったものは出力しない。 また、設定ファイルに port 要素が指定されている場合はそのポート番号を server ディレクティブに追加する。IPアドレステーブルが空の場合は"upstream upstream名 {server 127.0.0.1:10080}" という内容で出力する。
9. 接続可能になったら nginx プロセスに SIGHUP　シグナルを送信し nginx をリロードする。
10. DNSのTTL（複数IPの場合は最小の値）が切れるまで sleep する
11. 問い合わせの結果が変化していた場合、6. に戻ってループする。
シャットダウンシグナルを受信すると nginx プロセスに SIGQUIT　シグナルを送信し nginx をシャットダウンし、プログラムを終了する。
